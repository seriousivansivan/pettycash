<%- include('partials/head', { title: 'Histories', user }) %>

<div class="container-xxl py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0"><i class="bi bi-clock-history me-2"></i>Histories</h3>
    <span class="text-muted">Logged in as <strong><%= user.name %></strong> (<%= user.role %>)</span>
  </div>

  <form method="POST" action="/vouchers/bulk-delete" id="bulkForm" class="mb-3">
    <div class="toolbar d-flex flex-wrap gap-2 align-items-center">
      <div class="form-check me-2">
        <input class="form-check-input" type="checkbox" id="selectAll">
        <label class="form-check-label" for="selectAll">Select All</label>
      </div>
      <button type="submit" class="btn btn-outline-danger" id="softBtn">
        <i class="bi bi-trash"></i> Delete Selected
      </button>
      <% if (user.role === 'admin') { %>
        <button type="submit"
                class="btn btn-danger"
                id="hardBtn"
                formaction="/vouchers/bulk-hard-delete"
                formmethod="POST">
          <i class="bi bi-x-octagon"></i> Delete Permanently Selected
        </button>
      <% } %>
    </div>

    <div class="table-responsive bg-white shadow-sm rounded">
      <table id="histTable" class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:60px">No.</th>
            <th style="width:46px"><input type="checkbox" id="selectAllTop"></th>
            <th>Date</th>
            <th>Company</th>
            <th>Pay To</th>
            <th class="text-end">Total</th>
            <% if (user.role === 'admin') { %><th>Created By</th><% } %>
            <th>Created At</th>
            <th>PDF</th>
            <th style="width:200px">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% rows.forEach((r, idx) => { %>
            <tr>
              <td><%= idx + 1 %></td>
              <td><input type="checkbox" name="ids" value="<%= r.id %>" class="form-check-input rowChk"></td>
              <td><%= r.date %></td>
              <td><%= r.company %></td>
              <td><%= r.pay_to %></td>
              <td class="text-end"><%= Number(r.total).toFixed(2) %></td>
              <% if (user.role === 'admin') { %><td><%= r.created_by_name || '' %></td><% } %>
              <td><%= r.created_at_th %></td>
              <td><a class="btn btn-sm btn-outline-primary" href="/voucher/<%= r.id %>/pdf"><i class="bi bi-download"></i> Download</a></td>
              <td>
                <form class="d-inline" method="POST" action="/voucher/<%= r.id %>/delete" data-confirm="Delete this voucher?">
                  <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Delete</button>
                </form>
                <% if (user.role === 'admin') { %>
                  <form class="d-inline" method="POST" action="/voucher/<%= r.id %>/hard-delete" data-confirm="Permanently delete this voucher? This cannot be undone.">
                    <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-x-octagon"></i> Hard delete</button>
                  </form>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </form>
</div>

<%- include('partials/footer') %>

<script>
  const all1 = document.getElementById('selectAll');
  const all2 = document.getElementById('selectAllTop');
  const rowChecks = () => Array.from(document.querySelectorAll('.rowChk'));
  function setAll(checked){ rowChecks().forEach(cb => cb.checked = checked); }
  all1.addEventListener('change', e => { setAll(e.target.checked); all2.checked = e.target.checked; });
  all2.addEventListener('change', e => { setAll(e.target.checked); all1.checked = e.target.checked; });

  if (window.simpleDatatables) {
    new simpleDatatables.DataTable('#histTable', {
      perPage: 25,
      perPageSelect: [10,25,50,100],
      labels: { placeholder: 'Search...' },
      columns: [
        { select: 0, sortable: true,  searchable: false },
        { select: 1, sortable: false, searchable: false },
        { select: -1, sortable: false, searchable: false }
      ]
    });
  }

  async function confirmAction(title, text, danger) {
    const res = await Swal.fire({
      title, text, icon: 'warning', showCancelButton: true,
      confirmButtonText: 'Yes, continue',
      confirmButtonColor: danger ? '#dc3545' : '#0d6efd'
    });
    return res.isConfirmed;
  }

  const softBtn = document.getElementById('softBtn');
  const hardBtn = document.getElementById('hardBtn');
  softBtn?.addEventListener('click', async (e) => {
    if (!(await confirmAction('Delete selected?', 'You can restore them from Trash.', false))) e.preventDefault();
  });
  hardBtn?.addEventListener('click', async (e) => {
    if (!(await confirmAction('Delete permanently?', 'This cannot be undone.', true))) e.preventDefault();
  });

  document.querySelectorAll('form[data-confirm]').forEach(f => {
    f.addEventListener('submit', async (e) => {
      const msg = f.getAttribute('data-confirm') || 'Are you sure?';
      const ok = await Swal.fire({ title: 'Please confirm', text: msg, icon: 'warning', showCancelButton: true, confirmButtonColor:'#dc3545' }).then(r => r.isConfirmed);
      if (!ok) e.preventDefault();
    });
  });
</script>